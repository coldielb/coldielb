<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blog - Jason Weiss Zeledon</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                background-color: #000;
                color: #fff;
                font-family: "JetBrains Mono", monospace;
                line-height: 1.6;
                padding: 2rem;
                max-width: 900px;
                margin: 0 auto;
            }

            .header {
                margin-bottom: 3rem;
                border-bottom: 1px solid #333;
                padding-bottom: 2rem;
            }

            .site-title {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
                background: linear-gradient(135deg, #00ffff, #8a2be2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .site-subtitle {
                font-size: 1.2rem;
                font-weight: 400;
                margin-bottom: 1rem;
                color: #888;
            }

            .nav {
                display: flex;
                gap: 2rem;
                font-size: 0.9rem;
            }

            .nav a {
                color: #888;
                text-decoration: none;
                transition: color 0.2s ease;
            }

            .nav a:hover {
                color: #00ffff;
            }

            .nav a.active {
                background: linear-gradient(135deg, #00ffff, #8a2be2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .blog-header {
                margin-bottom: 2rem;
            }

            .blog-title {
                font-size: 2rem;
                font-weight: 600;
                margin-bottom: 1rem;
                background: linear-gradient(135deg, #00ffff, #8a2be2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .blog-description {
                color: #888;
                font-size: 1rem;
                margin-bottom: 1rem;
            }

            .loading {
                text-align: center;
                color: #888;
                font-style: italic;
                padding: 2rem;
            }

            .error {
                color: #ff6b6b;
                text-align: center;
                padding: 2rem;
                border: 1px solid #ff6b6b;
                border-radius: 0.5rem;
                background-color: rgba(255, 107, 107, 0.1);
            }

            .posts-container {
                display: grid;
                gap: 2rem;
            }

            /* Footer styling */
            .footer {
                margin-top: 4rem;
                padding: 2rem 0;
                border-top: 1px solid #333;
                text-align: center;
            }

            .support-text {
                font-size: 1rem;
                color: #ccc;
                margin-bottom: 1.5rem;
                font-weight: 400;
            }

            .donation-links {
                display: flex;
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .donation-link {
                padding: 0.75rem 1.5rem;
                border: 1px solid #333;
                border-radius: 6px;
                text-decoration: none;
                color: #ccc;
                transition: all 0.2s ease;
                background: rgba(0, 0, 0, 0.3);
                font-size: 0.9rem;
                font-weight: 500;
            }

            .donation-link:hover {
                border-color: #555;
                background: rgba(255, 255, 255, 0.05);
                transform: translateY(-2px);
            }

            .donation-link[data-platform="cashapp"]:hover {
                border-color: #00d632;
                color: #00d632;
            }

            .donation-link[data-platform="venmo"]:hover {
                border-color: #3d95ce;
                color: #3d95ce;
            }

            .donation-link[data-platform="paypal"]:hover {
                border-color: #0070ba;
                color: #0070ba;
            }

            @media (max-width: 768px) {
                .donation-links {
                    gap: 0.75rem;
                }
                
                .donation-link {
                    padding: 0.5rem 1rem;
                    font-size: 0.8rem;
                }
                
                .support-text {
                    font-size: 0.9rem;
                }
            }

            .post-card {
                border: 1px solid #333;
                border-radius: 0.5rem;
                padding: 1.5rem;
                background-color: #111;
                transition:
                    border-color 0.2s ease,
                    background-color 0.2s ease;
                cursor: pointer;
            }

            .post-card:hover {
                border-color: #00ffff;
                background-color: #1a1a1a;
            }

            .post-title {
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                background: linear-gradient(135deg, #00ffff, #8a2be2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .post-meta {
                display: flex;
                gap: 1rem;
                font-size: 0.8rem;
                color: #666;
                margin-bottom: 1rem;
                flex-wrap: wrap;
            }

            .post-preview {
                color: #ccc;
                font-size: 0.9rem;
                line-height: 1.5;
                margin-bottom: 1rem;
            }

            .post-tags {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .post-tag {
                background-color: #222;
                color: #00ffff;
                padding: 0.2rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.7rem;
                border: 1px solid #333;
            }

            .read-more {
                display: inline-block;
                margin-top: 1rem;
                color: #8a2be2;
                font-size: 0.8rem;
                text-decoration: none;
                font-weight: 500;
                transition: color 0.2s ease;
            }

            .read-more:hover {
                color: #00ffff;
            }

            .no-posts {
                text-align: center;
                color: #888;
                font-style: italic;
                padding: 3rem;
                border: 1px dashed #333;
                border-radius: 0.5rem;
            }

            .search-container {
                margin-bottom: 2rem;
            }

            .search-input {
                width: 100%;
                padding: 0.75rem;
                background-color: #111;
                border: 1px solid #333;
                border-radius: 0.5rem;
                color: #fff;
                font-family: "JetBrains Mono", monospace;
                font-size: 0.9rem;
            }

            .search-input:focus {
                outline: none;
                border-color: #00ffff;
            }

            .search-input::placeholder {
                color: #666;
            }

            .filter-container {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .filter-label {
                color: #888;
                font-size: 0.9rem;
            }

            .filter-select {
                background-color: #111;
                border: 1px solid #333;
                border-radius: 0.25rem;
                color: #fff;
                padding: 0.5rem;
                font-family: "JetBrains Mono", monospace;
                font-size: 0.8rem;
            }

            .filter-select:focus {
                outline: none;
                border-color: #00ffff;
            }

            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }

                .site-title {
                    font-size: 2rem;
                }

                .nav {
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .blog-title {
                    font-size: 1.5rem;
                }

                .post-meta {
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .filter-container {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1 class="site-title">frgmt.xyz</h1>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="blog.html" class="active">Blog</a>
                <a href="stories.html">Creative Works</a>
            </nav>
        </div>

        <div class="blog-header">
            <h2 class="blog-title">Blog Posts</h2>
            <p class="blog-description">
                Thoughts on systems programming, language design, and software
                engineering.
            </p>
        </div>

        <div class="search-container">
            <input
                type="text"
                class="search-input"
                placeholder="Search posts by title, content, or tags..."
                id="searchInput"
            />
        </div>

        <div class="filter-container">
            <span class="filter-label">Sort by:</span>
            <select class="filter-select" id="sortSelect">
                <option value="date-desc">Date (Newest First)</option>
                <option value="date-asc">Date (Oldest First)</option>
                <option value="title-asc">Title (A-Z)</option>
                <option value="title-desc">Title (Z-A)</option>
            </select>

            <span class="filter-label">Filter by tag:</span>
            <select class="filter-select" id="tagFilter">
                <option value="">All Tags</option>
            </select>
        </div>

        <div id="postsContainer">
            <div class="loading">Loading blog posts...</div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p class="support-text">Support what I make? Consider donating!</p>
            <div class="donation-links">
                <a href="https://cash.app/$tylerthebean" class="donation-link" data-platform="cashapp" target="_blank">CashApp</a>
                <a href="https://venmo.com/u/JasonWZ" class="donation-link" data-platform="venmo" target="_blank">Venmo</a>
                <a href="https://paypal.me/jasonawz" class="donation-link" data-platform="paypal" target="_blank">PayPal</a>
            </div>
        </footer>

        <script src="js/col-parser.js"></script>
        <script>
            class BlogListing {
                constructor() {
                    this.parser = new ColParser();
                    this.posts = [];
                    this.filteredPosts = [];
                    this.container = document.getElementById("postsContainer");
                    this.searchInput = document.getElementById("searchInput");
                    this.sortSelect = document.getElementById("sortSelect");
                    this.tagFilter = document.getElementById("tagFilter");

                    this.init();
                }

                async init() {
                    try {
                        await this.loadPosts();
                        this.setupEventListeners();
                        this.populateTagFilter();
                        this.renderPosts();
                    } catch (error) {
                        this.showError(
                            `Failed to load blog posts: ${error.message}`,
                        );
                    }
                }

                async loadPosts() {
                    try {
                        // Get list of .col files in the blog directory
                        const response = await fetch("blog/index.json");
                        let postFiles = [];

                        if (response.ok) {
                            const data = await response.json();
                            postFiles = data.posts || [];
                        } else {
                            // Fallback: try to load some common post files
                            postFiles = [
                                "welcome.col",
                                "rust-memory-safety.col",
                                "building-parsers.col",
                            ];
                        }

                        // Load each post file
                        const loadPromises = postFiles.map(async (filename) => {
                            try {
                                const parsed = await this.parser.loadFile(
                                    `blog/${filename}`,
                                );

                                // Ensure metadata.tags is always an array
                                if (
                                    !parsed.metadata.tags ||
                                    !Array.isArray(parsed.metadata.tags)
                                ) {
                                    parsed.metadata.tags = [];
                                }

                                return {
                                    filename,
                                    slug: filename.replace(".col", ""),
                                    ...parsed,
                                };
                            } catch (error) {
                                console.warn(
                                    `Failed to load ${filename}:`,
                                    error.message,
                                );
                                return null;
                            }
                        });

                        const results = await Promise.all(loadPromises);
                        this.posts = results.filter((post) => post !== null);
                        this.filteredPosts = [...this.posts];

                        // Debug logging
                        console.log("Loaded posts:", this.posts);
                        this.posts.forEach((post) => {
                            console.log(
                                `Post: ${post.metadata.title}, Tags:`,
                                post.metadata.tags,
                            );
                        });

                        // Sort by date (newest first) by default
                        this.sortPosts("date-desc");
                    } catch (error) {
                        throw new Error(
                            `Error loading posts: ${error.message}`,
                        );
                    }
                }

                setupEventListeners() {
                    this.searchInput.addEventListener("input", () => {
                        this.filterPosts();
                    });

                    this.sortSelect.addEventListener("change", () => {
                        this.sortPosts(this.sortSelect.value);
                        this.renderPosts();
                    });

                    this.tagFilter.addEventListener("change", () => {
                        this.filterPosts();
                    });
                }

                populateTagFilter() {
                    const allTags = new Set();
                    this.posts.forEach((post) => {
                        if (
                            post.metadata.tags &&
                            Array.isArray(post.metadata.tags)
                        ) {
                            post.metadata.tags.forEach((tag) =>
                                allTags.add(tag),
                            );
                        }
                    });

                    const sortedTags = Array.from(allTags).sort();
                    this.tagFilter.innerHTML =
                        '<option value="">All Tags</option>';

                    sortedTags.forEach((tag) => {
                        const option = document.createElement("option");
                        option.value = tag;
                        option.textContent = tag;
                        this.tagFilter.appendChild(option);
                    });
                }

                filterPosts() {
                    const searchTerm = this.searchInput.value.toLowerCase();
                    const selectedTag = this.tagFilter.value;

                    this.filteredPosts = this.posts.filter((post) => {
                        const matchesSearch =
                            !searchTerm ||
                            post.metadata.title
                                .toLowerCase()
                                .includes(searchTerm) ||
                            post.preview.toLowerCase().includes(searchTerm) ||
                            (post.metadata.tags &&
                                post.metadata.tags.some((tag) =>
                                    tag.toLowerCase().includes(searchTerm),
                                ));

                        const matchesTag =
                            !selectedTag ||
                            (post.metadata.tags &&
                                post.metadata.tags.includes(selectedTag));

                        return matchesSearch && matchesTag;
                    });

                    this.renderPosts();
                }

                sortPosts(sortBy) {
                    this.filteredPosts.sort((a, b) => {
                        switch (sortBy) {
                            case "date-desc":
                                return (
                                    new Date(b.metadata.date + 'T12:00:00') -
                                    new Date(a.metadata.date + 'T12:00:00')
                                );
                            case "date-asc":
                                return (
                                    new Date(a.metadata.date + 'T12:00:00') -
                                    new Date(b.metadata.date + 'T12:00:00')
                                );
                            case "title-asc":
                                return a.metadata.title.localeCompare(
                                    b.metadata.title,
                                );
                            case "title-desc":
                                return b.metadata.title.localeCompare(
                                    a.metadata.title,
                                );
                            default:
                                return 0;
                        }
                    });
                }

                renderPosts() {
                    if (this.filteredPosts.length === 0) {
                        this.container.innerHTML = `
                            <div class="no-posts">
                                ${
                                    this.posts.length === 0
                                        ? "No blog posts found. Create some .col files in the blog directory!"
                                        : "No posts match your search criteria."
                                }
                            </div>
                        `;
                        return;
                    }

                    this.container.innerHTML = `
                        <div class="posts-container">
                            ${this.filteredPosts.map((post) => this.renderPostCard(post)).join("")}
                        </div>
                    `;

                    // Add click handlers to post cards
                    this.container
                        .querySelectorAll(".post-card")
                        .forEach((card, index) => {
                            card.addEventListener("click", () => {
                                window.location.href = `post.html?slug=${this.filteredPosts[index].slug}`;
                            });
                        });
                }

                renderPostCard(post) {
                    const formattedDate = new Date(
                        post.metadata.date + 'T12:00:00',
                    ).toLocaleDateString("en-US", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    });

                    return `
                        <article class="post-card">
                            <h3 class="post-title">${this.escapeHtml(post.metadata.title)}</h3>
                            <div class="post-meta">
                                <span>By ${this.escapeHtml(post.metadata.author)}</span>
                                <span>${formattedDate}</span>
                                <span>${post.wordCount} words</span>
                                <span>${post.estimatedReadTime} min read</span>
                            </div>
                            ${post.preview ? `<div class="post-preview">${post.preview}</div>` : ""}
                            ${
                                post.metadata.tags &&
                                post.metadata.tags.length > 0
                                    ? `
                                <div class="post-tags">
                                    ${post.metadata.tags
                                        .map(
                                            (tag) =>
                                                `<span class="post-tag">${this.escapeHtml(tag)}</span>`,
                                        )
                                        .join("")}
                                </div>
                            `
                                    : ""
                            }
                            <a href="post.html?slug=${post.slug}" class="read-more">Read more →</a>
                        </article>
                    `;
                }

                escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                showError(message) {
                    this.container.innerHTML = `
                        <div class="error">
                            <strong>Error:</strong> ${this.escapeHtml(message)}
                        </div>
                    `;
                }
            }

            // Initialize blog listing when DOM is loaded
            document.addEventListener("DOMContentLoaded", () => {
                new BlogListing();
            });
        </script>
    </body>
</html>
